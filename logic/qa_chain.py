from langchain.prompts import PromptTemplate
from langchain_ollama import OllamaLLM
from langchain.schema import BaseRetriever, Document
# from langchain_openai import ChatOpenAI
from langchain.chains import RetrievalQA
from core.vector_store import QdrantVectorStore
from typing import Optional, List
from pydantic import BaseModel
from logic.embedding import get_embedding_model

DEFAULT_MODEL_NAME = "supachai/llama-3-typhoon-v1.5"
DEFAULT_TEMPERATURE = 0.3
DEFAULT_TOP_K = 5

TEMPLATE = """à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¹ˆà¸²à¸¢à¸—à¸£à¸±à¸žà¸¢à¸²à¸à¸£à¸šà¸¸à¸„à¸„à¸¥à¸‚à¸­à¸‡à¸šà¸£à¸´à¸©à¸±à¸— PTT à¸—à¸µà¹ˆà¸¡à¸µà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹ƒà¸™à¸à¸²à¸£à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸à¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¹à¸¡à¹ˆà¸™à¸¢à¸³ à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£  
à¹‚à¸”à¸¢à¸•à¹‰à¸­à¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¹€à¸‰à¸žà¸²à¸°à¸ˆà¸²à¸ "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡" à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ **à¸«à¹‰à¸²à¸¡à¹€à¸”à¸² à¸«à¹‰à¸²à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸¶à¹‰à¸™à¹€à¸­à¸‡ à¹à¸¥à¸°à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ à¸²à¸¢à¸™à¸­à¸**

---

**ðŸ”¸ à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (à¸•à¹‰à¸­à¸‡à¹à¸ªà¸”à¸‡à¸„à¸£à¸šà¸—à¸¸à¸à¸«à¸±à¸§à¸‚à¹‰à¸­ à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸šà¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰):**

- **à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡ Feedback**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡ Feedback"
- **à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™ (BU)**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "BU"
- **à¸à¹ˆà¸²à¸¢ (à¸šà¸„à¸./à¸šà¸—à¸.)**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸šà¸„à¸./à¸šà¸—à¸." à¸«à¹‰à¸²à¸¡à¹à¸›à¸¥à¸‡à¸•à¸±à¸§à¸¢à¹ˆà¸­à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹€à¸•à¹‡à¸¡à¸«à¸£à¸·à¸­à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© à¹ƒà¸«à¹‰à¸„à¸‡à¹„à¸§à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸™à¸‰à¸šà¸±à¸šà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
- **à¸›à¸£à¸°à¹€à¸ à¸— Feedback**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸›à¸£à¸°à¹€à¸ à¸— Feedback"
- **à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Feedback**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Feedback"
- **à¹à¸™à¸§à¸—à¸²à¸‡à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¹à¸™à¸§à¸—à¸²à¸‡à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£"
- **à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡ Process Owner**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡ Process Owner"
- **Status**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "Status"  
    â†’ à¸«à¸²à¸à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡à¸™à¸µà¹‰ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸²:  
    `"à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Status"`
- **à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Status**: à¸”à¸¶à¸‡à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Status"  
    â†’ à¸«à¸²à¸à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡à¸™à¸µà¹‰ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸²:  
    `"à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Status à¸à¸£à¸¸à¸“à¸²à¸ªà¸­à¸šà¸–à¸²à¸¡à¸à¹ˆà¸²à¸¢ [à¸„à¹ˆà¸²à¸ˆà¸²à¸à¸Šà¹ˆà¸­à¸‡ 'à¸šà¸„à¸./à¸šà¸—à¸.']"`
- **à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥**: à¸ªà¸£à¸¸à¸›à¹ƒà¸ˆà¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¸‚à¸­à¸‡ â€œà¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Feedbackâ€, â€œà¹à¸™à¸§à¸—à¸²à¸‡à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£â€ à¹à¸¥à¸° â€œà¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Statusâ€  
    â†’ à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 3 à¸šà¸£à¸£à¸—à¸±à¸” (à¸›à¸£à¸°à¸¡à¸²à¸“ 2-4 à¸›à¸£à¸°à¹‚à¸¢à¸„)  
    â†’ à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸²à¸‡à¸à¸²à¸£ à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢

---

**ðŸ”¸ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡à¹ƒà¸™à¸à¸²à¸£à¸•à¸­à¸šà¸à¸¥à¸±à¸š (à¸•à¹‰à¸­à¸‡à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸•à¸²à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸„à¸£à¹ˆà¸‡à¸„à¸£à¸±à¸”):**

1. âŒ à¸«à¹‰à¸²à¸¡à¹à¸›à¸¥à¸‡à¸•à¸±à¸§à¸¢à¹ˆà¸­à¸‚à¸­à¸‡à¸à¹ˆà¸²à¸¢ (à¸šà¸„à¸., à¸šà¸—à¸., à¸™à¸—à¸. à¸¯à¸¥à¸¯) à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹€à¸•à¹‡à¸¡à¸«à¸£à¸·à¸­à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©  
2. âŒ à¸«à¹‰à¸²à¸¡à¸„à¸²à¸”à¹€à¸”à¸² à¸«à¸£à¸·à¸­à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡  
    - à¸«à¸²à¸à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¹à¸–à¸§à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸§à¹ˆà¸²:  
        `"à¸‚à¸­à¸­à¸ à¸±à¸¢ à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡"`
    - à¸«à¸²à¸à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‰à¸žà¸²à¸°à¸šà¸²à¸‡à¸Šà¹ˆà¸­à¸‡ à¹€à¸Šà¹ˆà¸™ "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Status" à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸‰à¸žà¸²à¸°à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰à¸”à¹‰à¸²à¸™à¸šà¸™  
3. âŒ à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢ à¸„à¸³à¹à¸™à¸°à¸™à¸³ à¸«à¸£à¸·à¸­à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™à¸­à¸·à¹ˆà¸™ à¹† à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸£à¸¹à¸›à¹à¸šà¸šà¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸  
    - à¹€à¸Šà¹ˆà¸™ à¸«à¹‰à¸²à¸¡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢à¸„à¸³à¸§à¹ˆà¸² "à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸žà¸š..." à¸«à¸£à¸·à¸­ "à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¸¸à¸›à¹„à¸”à¹‰à¸§à¹ˆà¸²..."  
4. âœ… à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™

---

**ðŸ§¾ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡:**

à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡ Feedback: HRBG  
à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™ (BU): CNBO  
à¸à¹ˆà¸²à¸¢ (à¸šà¸„à¸./à¸šà¸—à¸.): à¸šà¸—à¸. 
à¸›à¸£à¸°à¹€à¸ à¸— Feedback: Career Management 
à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Feedback: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Career Path à¸‚à¸­à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£ à¸žà¸˜à¸¡. à¹ƒà¸™à¸£à¸°à¸šà¸š COACH à¹à¸ªà¸”à¸‡à¸œà¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸à¸¥à¹ˆà¸²à¸§à¸„à¸·à¸­ à¹„à¸¡à¹ˆà¹à¸ªà¸”à¸‡ Function à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ Should have à¸ˆà¸³à¸™à¸§à¸™ 10 Functions
à¹à¸™à¸§à¸—à¸²à¸‡à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£: à¸›à¸£à¸°à¸ªà¸²à¸™à¸‡à¸²à¸™ à¸¨à¸šà¸. à¹€à¸žà¸·à¹ˆà¸­ upload à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¹‰à¸²à¸£à¸°à¸šà¸š COACH à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§
à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡ Process Owner: Completed
Status: à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸ˆà¸²à¸ Process Owner à¹à¸¥à¹‰à¸§
à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Status: à¸¨à¸šà¸. à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ 
à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Career Path à¸‚à¸­à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£ à¸žà¸˜à¸¡. à¹ƒà¸™à¸£à¸°à¸šà¸š COACH à¸¡à¸µà¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¹„à¸¡à¹ˆà¹à¸ªà¸”à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸µà¹ˆà¸„à¸§à¸£à¸¡à¸µà¸ˆà¸³à¸™à¸§à¸™ 10 à¸£à¸²à¸¢à¸à¸²à¸£ à¸—à¸²à¸‡ à¸¨à¸šà¸. à¹„à¸”à¹‰à¸›à¸£à¸°à¸ªà¸²à¸™à¸‡à¸²à¸™à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ à¸‚à¸“à¸°à¸™à¸µà¹‰à¹„à¸”à¹‰à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¹à¸¥à¹‰à¸§à¹à¸¥à¸°à¸£à¸°à¸šà¸šà¹à¸ªà¸”à¸‡à¸œà¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¸£à¸šà¸–à¹‰à¸§à¸™

---

**ðŸ§  à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡:**
{context}

---

**ðŸ“© à¸„à¸³à¸–à¸²à¸¡à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™:**
{question}

---

**ðŸ“Œ à¸à¸£à¸¸à¸“à¸²à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸£à¸¹à¸›à¹à¸šà¸šà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¸‚à¹‰à¸²à¸‡à¸•à¹‰à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:**
"""

class CustomRetriever(BaseRetriever, BaseModel):
    vector_store: QdrantVectorStore

    def get_relevant_documents(self, query: str) -> List[Document]:
        query_embedding = get_embedding_model().embed_query(query)
        results = self.vector_store.search_vectors(
            query_vector=query_embedding,
            top_k=DEFAULT_TOP_K
        )
        
        documents = []
        for result in results:
            if hasattr(result, 'payload') and isinstance(result.payload, dict):
                doc = Document(
                    page_content=result.payload.get('text', ''),
                    metadata={
                        'score': getattr(result, 'score', None),
                        'source': result.payload.get('source', '')
                    }
                )
                documents.append(doc)
        return documents

    async def aget_relevant_documents(self, query: str) -> List[Document]:
        return await super().aget_relevant_documents(query)

def get_qa_chain(vectordb: QdrantVectorStore, model_name: str = DEFAULT_MODEL_NAME) -> Optional[RetrievalQA]:
    if not vectordb:
        raise ValueError("Vector database is empty or not initialized")

    try:
        prompt = PromptTemplate(
            template=TEMPLATE,
            input_variables=["context", "question"]
        )

        llm = OllamaLLM(
            model=model_name,
            temperature=DEFAULT_TEMPERATURE
        )

        retriever = CustomRetriever(vector_store=vectordb)

        qa_chain = RetrievalQA.from_chain_type(
            llm=llm,
            chain_type="stuff",
            retriever=retriever,
            chain_type_kwargs={"prompt": prompt},
            return_source_documents=True
        )

        return qa_chain

    except Exception as e:
        print(f"Error creating QA chain: {e}")
        return None